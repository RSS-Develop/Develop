<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eskilstuna Evenemang - Lista</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: black;
      color: white;
      font-family: Arial, sans-serif;
    }

    /* En container för hela listan */
    #eventList {
      display: flex;
      flex-direction: column; /* Lodrät lista */
      gap: 10px;             /* Avstånd mellan varje event-item */
      max-width: 800px;      /* Anpassa efter hur bred du vill att listan ska vara */
      margin: 0 auto;        /* Centrera listan i webbläsarfönstret */
      padding: 20px;
    }

    /* Varje event presenteras i en "rad" */
    .event-item {
      display: flex;
      flex-direction: row;   /* Bild till vänster, text till höger */
      background-color: #333;
      border-radius: 5px;
      overflow: hidden;
      align-items: center;
      min-height: 80px; /* så vi har utrymme för bilden */
    }

    /* Bilden */
    .event-image {
      width: 80px;
      height: 80px;
      object-fit: cover;  /* Beskär bilden om den är för stor / annan ratio */
      flex-shrink: 0;     /* Förhindra att bilden trycks ihop */
      background-color: #555; /* fallback om ingen bild hittas */
    }

    /* Text-området bredvid bilden */
    .event-info {
      display: flex;
      flex-direction: column;
      padding: 8px 10px;
      justify-content: center;
      flex-grow: 1; /* Gör så textytan kan bre ut sig */
    }

    .event-date {
      font-weight: bold;
      margin-bottom: 4px;
    }

    .event-title {
      font-size: 1.1rem;
      margin: 0;
      line-height: 1.4;
    }

    .event-location {
      color: #ccc;
      font-size: 0.95rem;
      margin-top: 4px;
    }
  </style>
</head>
<body>

  <div id="eventList">
    <!-- Här stoppar vi in event-rader dynamiskt via JavaScript -->
  </div>

<script>
  // URL till rss2json (hämta ditt RSS-flöde i JSON-format)
  const rssUrl = 'https://api.rss2json.com/v1/api.json?rss_url=' + 
    encodeURIComponent(
      'https://visiteskilstuna.se/rest-api/rssService/getRssFeed?portletId=12.5b899160171ac5273c72ad9f&pageId=2.369be3c31580a19562d1977e'
    );

  // Svenska månader för datumformat
  const swedishMonths = {
    "jan": 1, "januari": 1,
    "feb": 2, "februari": 2,
    "mar": 3, "mars": 3,
    "apr": 4, "april": 4,
    "maj": 5,
    "jun": 6, "juni": 6,
    "jul": 7, "juli": 7,
    "aug": 8, "augusti": 8,
    "sep": 9, "sept": 9, "september": 9,
    "okt": 10, "oktober": 10,
    "nov": 11, "november": 11,
    "dec": 12, "december": 12
  };

  /**
   * formatDateRange:
   * "5 feb - 8 feb" => "5/2 - 8/2"
   * "5 feb" => "5/2"
   */
  function formatDateRange(title) {
    // Fångar "xx mån" eller "xx mån - xx mån"
    const datePattern = /^(\d{1,2})\s*([a-zA-ZåäöÅÄÖ]+)(?:\s*-\s*(\d{1,2})\s*([a-zA-ZåäöÅÄÖ]+))?/i;
    const match = title.match(datePattern);
    if (match) {
      const startDay = parseInt(match[1], 10);
      const startMonthStr = match[2].toLowerCase();
      const startMonthNum = swedishMonths[startMonthStr] || null;
      if (!startMonthNum) return '';

      const endDayStr = match[3];
      const endMonthStr = match[4] ? match[4].toLowerCase() : null;

      if (endDayStr && endMonthStr && swedishMonths[endMonthStr]) {
        const endDay = parseInt(endDayStr, 10);
        const endMonthNum = swedishMonths[endMonthStr];
        return `${startDay}/${startMonthNum} - ${endDay}/${endMonthNum}`;
      } else {
        return `${startDay}/${startMonthNum}`;
      }
    }
    return '';
  }

  /**
   * removeDateFromTitle:
   * T.ex. "5 feb - 8 feb, Folk och Kultur" => "Folk och Kultur"
   */
  function removeDateFromTitle(title) {
    return title.replace(
      /^(\d{1,2}\s*[a-zA-ZåäöÅÄÖ]+(?:\s*-\s*\d{1,2}\s*[a-zA-ZåäöÅÄÖ]+)?)[\s,:\-–]+/i, 
      ''
    ).trim();
  }

  // Avkodar t.ex. "&amp;" till "&"
  function decodeHtmlEntities(text) {
    const textarea = document.createElement('textarea');
    textarea.innerHTML = text;
    return textarea.value;
  }

  /**
   * Försök att plocka "Plats" ur <description>.
   * Ex: <description>...Plats: Eskilstuna stadsmuseum<br>...
   * Du kan behöva anpassa detta beroende på hur texten är uppbyggd!
   */
  function extractLocation(description) {
    if (!description) return '';
    // T.ex. letar efter "Plats: " + resten fram till <br> eller liknande
    const match = description.match(/Plats:\s*(.*?)(<br|<\/p|$)/i);
    if (match) {
      return match[1].trim();
    }
    return '';
  }

  // Hämta data och bygg listan
  async function fetchAndDisplayEvents() {
    try {
      const response = await fetch(rssUrl);
      if (!response.ok) {
        throw new Error("Kunde inte hämta RSS-flödet.");
      }

      const data = await response.json();
      const items = data.items || [];

      // Element där vi ska stoppa in listan
      const eventListElem = document.getElementById('eventList');
      // Rensa eventuellt gamla data
      eventListElem.innerHTML = '';

      // Visa max 6 events
      const maxEvents = 6;
      const limitedItems = items.slice(0, maxEvents);

      limitedItems.forEach(item => {
        let titleRaw = (item.title || '').trim();
        let descRaw = (item.description || '').trim();

        // 1) Hitta datum i titeln
        const formattedDate = formatDateRange(titleRaw);
        // 2) Ta bort datum ur titeln
        const cleanedTitle = removeDateFromTitle(titleRaw);
        // 3) Avkoda HTML
        const finalTitle = decodeHtmlEntities(cleanedTitle);

        // 4) Försök extrahera plats
        const location = extractLocation(descRaw);

        // 5) Hämta bild från enclosure
        // rss2json kan placera den i .enclosure.link eller .enclosure.url
        let imageUrl = '';
        if (item.enclosure) {
          // Kolla om det heter .link eller .url
          if (item.enclosure.link) {
            imageUrl = item.enclosure.link;
          } else if (item.enclosure.url) {
            imageUrl = item.enclosure.url;
          }
        }
        // Fallback om ingen bild hittas
        if (!imageUrl) {
          imageUrl = 'https://via.placeholder.com/80?text=No+Image';
        }

        // Bygg upp DOM-element
        const eventItem = document.createElement('div');
        eventItem.classList.add('event-item');

        const imgEl = document.createElement('img');
        imgEl.classList.add('event-image');
        imgEl.src = imageUrl;
        imgEl.alt = "Event image";

        const infoDiv = document.createElement('div');
        infoDiv.classList.add('event-info');

        // Datum
        const dateDiv = document.createElement('div');
        dateDiv.classList.add('event-date');
        dateDiv.textContent = formattedDate;

        // Titel
        const titleDiv = document.createElement('div');
        titleDiv.classList.add('event-title');
        titleDiv.textContent = finalTitle;

        // Plats
        if (location) {
          const locationDiv = document.createElement('div');
          locationDiv.classList.add('event-location');
          locationDiv.textContent = location;
          infoDiv.appendChild(locationDiv);
          // Tips: Du kanske vill visa plats *före* eller *efter* titel, smaksak.
        }

        // Lägg in date + title i infoDiv
        // (Du kan välja ordningsföljd själv!)
        if (formattedDate) {
          infoDiv.appendChild(dateDiv);
        }
        infoDiv.appendChild(titleDiv);

        eventItem.appendChild(imgEl);
        eventItem.appendChild(infoDiv);

        // Lägg in i #eventList
        eventListElem.appendChild(eventItem);
      });

    } catch (error) {
      console.error(error);
      const eventListElem = document.getElementById('eventList');
      eventListElem.innerHTML = `<p>Fel uppstod: ${error.message}</p>`;
    }
  }

  // Kör direkt när sidan laddas
  fetchAndDisplayEvents();

  // Upprepa var 5:e minut
  setInterval(fetchAndDisplayEvents, 300000);
</script>
</body>
</html>
