<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=576, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eskilstuna Info</title>
    <style>
        body {
            background-color: black;
            color: white;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0 10px;
            width: 576px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        #eventContainer {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .event-text {
            font-size: var(--font-size, 36px); /* Använder beräknad storlek */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            line-height: 1;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="eventContainer">
        <div id="eventText" class="event-text">Välkommen till Eskilstuna</div>
    </div>

<script>
const RSS_URL = 'https://api.allorigins.win/get?url=' + encodeURIComponent('https://visiteskilstuna.se/rest-api/rssService/getRssFeed?portletId=12.5b899160171ac5273c72ad9f&pageId=2.369be3c31580a19562d1977e');
const MAX_LENGTH = 31;
let events = [];
let currentEventIndex = 0;
const monthMap = {
    "jan": "01", "feb": "02", "mar": "03", "apr": "04",
    "maj": "05", "jun": "06", "jul": "07", "aug": "08",
    "sep": "09", "okt": "10", "nov": "11", "dec": "12"
};

// Optimal textstorlek baserad på faktisk textlängd
function calculateOptimalFontSize() {
    const testElement = document.createElement('div');
    testElement.className = 'event-text';
    testElement.style.position = 'absolute';
    testElement.style.visibility = 'hidden';
    testElement.textContent = 'W'.repeat(MAX_LENGTH);
    
    document.body.appendChild(testElement);
    
    let fontSize = 64;
    while (testElement.scrollWidth > 576 && fontSize > 12) {
        fontSize--;
        testElement.style.fontSize = `${fontSize}px`;
    }
    
    document.body.removeChild(testElement);
    return fontSize;
}

// Tillämpa font-storlek
document.documentElement.style.setProperty('--font-size', `${calculateOptimalFontSize()}px`);

// Förbättrad datumhantering
function formatDate(title) {
    const dateMatch = title.match(/(\d{1,2})\s*([a-zåäö]+)\s*([-–]\s*(\d{1,2})\s*([a-zåäö]+))?/i);
    if (!dateMatch) return '';
    
    const startDay = dateMatch[1].padStart(2, '0');
    const startMonth = monthMap[dateMatch[2].toLowerCase()] || '00';
    
    if (dateMatch[4] && dateMatch[5]) {
        const endDay = dateMatch[4].padStart(2, '0');
        const endMonth = monthMap[dateMatch[5].toLowerCase()] || '00';
        return `${startDay}/${startMonth}–${endDay}/${endMonth}`;
    }
    return `${startDay}/${startMonth}`;
}

// Stabil datahämtning
async function fetchData() {
    try {
        const response = await fetch(RSS_URL);
        if (!response.ok) throw new Error('Kunde inte hämta data');
        
        const data = await response.json();
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(data.contents, "text/xml");
        const items = xmlDoc.querySelectorAll('item');
        
        const newEvents = [];
        items.forEach(item => {
            const title = item.querySelector('title')?.textContent?.trim() || '';
            const date = formatDate(title);
            const cleanTitle = title.replace(/^(\d{1,2}\s*[a-zåäö]+\s*([-–]\s*\d{1,2}\s*[a-zåäö]+)?)/i, '').trim();
            
            if (date && cleanTitle) {
                const displayText = `${date} ${cleanTitle}`.substring(0, MAX_LENGTH).trim();
                newEvents.push(displayText);
            }
        });

        if (newEvents.length > 0) {
            events = newEvents;
            currentEventIndex = 0;
            updateDisplay();
        }
    } catch (error) {
        console.error('Fel:', error);
        showWelcomeMessage();
    }
}

function updateDisplay() {
    const displayElement = document.getElementById('eventText');
    if (events.length > 0) {
        displayElement.textContent = events[currentEventIndex];
        currentEventIndex = (currentEventIndex + 1) % events.length;
    } else {
        showWelcomeMessage();
    }
}

function showWelcomeMessage() {
    document.getElementById('eventText').textContent = 'Välkommen till Eskilstuna';
}

// Initialisering
fetchData();
setInterval(fetchData, 300000); // Uppdatera var 5:e minut
setInterval(updateDisplay, 10000); // Byt text var 10:e sekund
</script>
</body>
</html>
