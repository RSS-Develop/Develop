<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <!-- Låser viewport till 576px för en skärm som verkligen är 576x64 -->
    <meta name="viewport" content="width=576, initial-scale=1.0">
    <title>RSS Läsare (576x64)</title>
    <style>
        /* Hela sidan matchar exakt skärmens mått 576x64 */
        body {
            margin: 0;
            padding: 0;
            width: 576px;
            height: 64px;
            overflow: hidden; /* Hindrar scrollbars */
            background-color: black;
            color: white;
            font-family: Arial, sans-serif;
        }

        /* En container för texten, 576x64, med lite vänstermarginal */
        #rssFeed {
            width: 576px;
            height: 64px;
            box-sizing: border-box;
            overflow: hidden;
            display: flex;
            align-items: center;        /* Vertikal centrering */
            justify-content: flex-start; /* Vänsterjusterat */
            padding-left: 10px;
        }

        /* Själva textfältet */
        #eventTitle {
            font-size: 30px;
            margin: 0;
            line-height: 64px;      /* Matchar höjden */
            white-space: nowrap;
            overflow: hidden;
            position: relative;     /* För att .scroll-text ska kunna positioneras absolut */
            text-align: left;
        }

        /* Marquee-effekt för långa texter */
        .scroll-text {
            position: absolute;
            line-height: 64px;
            /* Starta texten precis utanför högerkanten (100%) och rulla över */
            padding-left: 100%;
            animation: marquee 15s linear infinite; 
            /* Du kan justera 15s om du vill rulla snabbare/långsammare */
            white-space: nowrap;
        }

        @keyframes marquee {
            0%   { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
    </style>
</head>
<body>
    <div id="rssFeed">
        <div id="eventTitle">VÄLKOMMEN TILL ESKILSTUNA</div>
    </div>

<script>
    // URL för rss2json
    const rssUrl = 'https://api.rss2json.com/v1/api.json?rss_url=' + 
        encodeURIComponent('https://visiteskilstuna.se/rest-api/rssService/getRssFeed?portletId=12.5b899160171ac5273c72ad9f&pageId=2.369be3c31580a19562d1977e');
    
    let events = [];
    let currentEventIndex = 0;
    let eventInterval;

    // Mapp för svenska månader (både korta och långa namn)
    const swedishMonths = {
        "jan": 1, "januari": 1,
        "feb": 2, "februari": 2,
        "mar": 3, "mars": 3,
        "apr": 4, "april": 4,
        "maj": 5,
        "jun": 6, "juni": 6,
        "jul": 7, "juli": 7,
        "aug": 8, "augusti": 8,
        "sep": 9, "sept": 9, "september": 9,
        "okt": 10, "oktober": 10,
        "nov": 11, "november": 11,
        "dec": 12, "december": 12
    };

    /**
     * formatDateRange
     * Försöker hitta datumformat i början av titeln:
     * Ex: "14 maj - 16 maj" -> "14/5 - 16/5"
     * eller "14 maj" -> "14/5"
     * Returnerar tom sträng om ingen match.
     */
    function formatDateRange(title) {
        // Regex:
        //  - (\d{1,2}) fångar dag (1-2 siffror)
        //  - ([a-zA-ZåäöÅÄÖ]+) fångar månad (svenska, ex "maj", "juni", "oktober", etc.)
        //  - (?: ... )? fångar ev. andra datumet
        const datePattern = /^(\d{1,2})\s*([a-zA-ZåäöÅÄÖ]+)(?:\s*-\s*(\d{1,2})\s*([a-zA-ZåäöÅÄÖ]+))?/i;
        const match = title.match(datePattern);
        if (match) {
            const startDay = parseInt(match[1], 10);
            const startMonthStr = match[2].toLowerCase(); 
            const startMonth = swedishMonths[startMonthStr] || null;

            if (!startMonth) return ''; // Om månad inte hittas i tabellen, avbryt

            // Kollar om vi har ett andra intervall
            const endDayStr = match[3];
            const endMonthStr = match[4] ? match[4].toLowerCase() : null;

            if (endDayStr && endMonthStr && swedishMonths[endMonthStr]) {
                const endDay = parseInt(endDayStr, 10);
                const endMonth = swedishMonths[endMonthStr];
                return `${startDay}/${startMonth} - ${endDay}/${endMonth}`; 
            } else {
                return `${startDay}/${startMonth}`;
            }
        }
        return '';
    }

    // Avkodar HTML-tecken (ex. &amp; -> &)
    function decodeHtmlEntities(text) {
        const textarea = document.createElement('textarea');
        textarea.innerHTML = text;
        return textarea.value;
    }

    async function fetchRSS() {
        try {
            const response = await fetch(rssUrl);
            if (!response.ok) throw new Error("Kunde inte hämta RSS-flödet.");

            const data = await response.json();
            const items = data.items;

            events = [];

            // Bygg upp events-lista
            for (let i = 0; i < items.length; i++) {
                let title = items[i].title || '';
                title = title.trim();

                // Fånga upp datum i titeln
                const formattedDate = formatDateRange(title);

                // Ta bort själva datumet ur början av titeln
                // Samma regex (i stort sett) fast vi använder "replace"
                // för att rensa bort den delen ur texten
                title = title.replace(
                    /^(\d{1,2}\s*[a-zA-ZåäöÅÄÖ]+(?:\s*-\s*\d{1,2}\s*[a-zA-ZåäöÅÄÖ]+)?)/i, 
                    ''
                ).trim();

                // Om det finns tecken som t.ex. &amp; etc., avkoda dem
                title = decodeHtmlEntities(title);

                // Bygg "Slutlig" text (datum + event-titel)
                // Om formattedDate saknas blir det bara event-titeln
                const displayTitle = (formattedDate ? formattedDate + ' ' : '') + title;

                // Lägg in i array
                events.push({ title: displayTitle.trim() });
            }

            // Om vi inte redan har en timer igång för att visa event, starta den
            if (!eventInterval) {
                showNextEvent();
                // Byt event var 10:e sekund
                eventInterval = setInterval(showNextEvent, 10000);
            }

        } catch (error) {
            console.error(error);
            resetToWelcomeMessage();
        }
    }

    // Visar nästa event i listan
    function showNextEvent() {
        const eventTitleElem = document.getElementById("eventTitle");

        if (events.length > 0) {
            const currentText = events[currentEventIndex].title;

            // Om texten är väldigt lång -> rulla
            if (currentText.length > 40) {
                eventTitleElem.innerHTML = `<div class="scroll-text">${currentText}</div>`;
            } else {
                eventTitleElem.textContent = currentText;
            }

            currentEventIndex = (currentEventIndex + 1) % events.length;
        } else {
            resetToWelcomeMessage();
        }
    }

    // Återställ välkomstmeddelande
    function resetToWelcomeMessage() {
        const eventTitleElem = document.getElementById("eventTitle");
        eventTitleElem.textContent = 'VÄLKOMMEN TILL ESKILSTUNA';
    }

    // Hämta RSS direkt vid sidstart
    fetchRSS();

    // Hämta nya data var 5:e minut
    setInterval(fetchRSS, 300000);
</script>
</body>
</html>
