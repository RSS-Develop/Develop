<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RSS Läsare (Vänsterställd, centrerad vertikalt)</title>
  <style>
    /* 
      BODY fyller hela webbläsarfönstret i höjdled (100vh).
      Bakgrunden är svart.
      Texten placeras (med flex) längs vänsterkanten (justify-content: flex-start),
      men är centrerad vertikalt (align-items: center).
    */
    body {
      background-color: black;
      color: white;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;

      display: flex;
      justify-content: flex-start; /* Vänsterställd horisontellt */
      align-items: center;         /* Vertikalt centrerad */
      height: 100vh;               /* Fyll hela fönstrets höjd */
    }

    /*
      #rssFeed är en flexibel behållare för texten,
      ligger mot vänsterkanten tack vare body.
      padding-left: 10px ger lite luft i vänsterkanten.
    */
    #rssFeed {
      max-width: 100%;   /* Så den inte överskrider fönstrets bredd */
      padding-left: 10px;
      box-sizing: border-box;
      line-height: 1.2;
      overflow: hidden;  /* Dölj ev. extra text om rullning sker */
    }

    /* Själva textytan */
    #eventTitle {
      font-size: 30px;
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      position: relative; 
      text-align: left;
      line-height: 1.2;  /* Du kan byta till 64px om du vill */
    }

    /* Rullande text (marquee) när för långt (> 40 tecken) */
    .scroll-text {
      position: absolute;
      white-space: nowrap;
      padding-left: 100%;
      animation: marquee 15s linear infinite;
    }

    @keyframes marquee {
      0%   { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }
  </style>
</head>
<body>

  <div id="rssFeed">
    <div id="eventTitle">VÄLKOMMEN TILL ESKILSTUNA</div>
  </div>

<script>
  // RSS via rss2json
  const rssUrl = 'https://api.rss2json.com/v1/api.json?rss_url=' + 
    encodeURIComponent(
      'https://visiteskilstuna.se/rest-api/rssService/getRssFeed?portletId=12.5b899160171ac5273c72ad9f&pageId=2.369be3c31580a19562d1977e'
    );

  let events = [];
  let currentEventIndex = 0;
  let eventInterval;

  // Svenska månader (inkl. åäö, kort+långa)
  const swedishMonths = {
    "jan": 1, "januari": 1,
    "feb": 2, "februari": 2,
    "mar": 3, "mars": 3,
    "apr": 4, "april": 4,
    "maj": 5,
    "jun": 6, "juni": 6,
    "jul": 7, "juli": 7,
    "aug": 8, "augusti": 8,
    "sep": 9, "sept": 9, "september": 9,
    "okt": 10, "oktober": 10,
    "nov": 11, "november": 11,
    "dec": 12, "december": 12
  };

  /**
   * formatDateRange:
   * T.ex. "5 feb - 8 feb" => "5/2 - 8/2"
   */
  function formatDateRange(title) {
    const datePattern = /^(\d{1,2})\s*([a-zA-ZåäöÅÄÖ]+)(?:\s*-\s*(\d{1,2})\s*([a-zA-ZåäöÅÄÖ]+))?/i;
    const match = title.match(datePattern);
    if (match) {
      const startDay = parseInt(match[1], 10);
      const startMonthStr = match[2].toLowerCase();
      const startMonthNum = swedishMonths[startMonthStr] || null;
      if (!startMonthNum) return '';

      const endDayStr = match[3];
      const endMonthStr = match[4] ? match[4].toLowerCase() : null;

      if (endDayStr && endMonthStr && swedishMonths[endMonthStr]) {
        const endDay = parseInt(endDayStr, 10);
        const endMonthNum = swedishMonths[endMonthStr];
        return `${startDay}/${startMonthNum} - ${endDay}/${endMonthNum}`;
      } else {
        return `${startDay}/${startMonthNum}`;
      }
    }
    return '';
  }

  /**
   * removeDateFromTitle:
   * Tar bort datum + ev. skiljetecken direkt efter.  
   * T.ex. "5 feb - 8 feb, Folk och Kultur" -> "Folk och Kultur"
   */
  function removeDateFromTitle(title) {
    return title.replace(
      /^(\d{1,2}\s*[a-zA-ZåäöÅÄÖ]+(?:\s*-\s*\d{1,2}\s*[a-zA-ZåäöÅÄÖ]+)?)[\s,:\-–]+/i, 
      ''
    ).trim();
  }

  // Avkodar HTML-entities, ex &amp; -> &
  function decodeHtmlEntities(text) {
    const textarea = document.createElement('textarea');
    textarea.innerHTML = text;
    return textarea.value;
  }

  // Hämta RSS
  async function fetchRSS() {
    try {
      const response = await fetch(rssUrl);
      if (!response.ok) throw new Error("Kunde inte hämta RSS-flödet.");

      const data = await response.json();
      const items = data.items;

      events = [];

      for (let i = 0; i < items.length; i++) {
        let title = (items[i].title || '').trim();

        // Extrahera datum
        const formattedDate = formatDateRange(title);

        // Ta bort datumet ur titeln (inkl. ev. kommatecken, etc.)
        title = removeDateFromTitle(title);

        // Avkoda HTML
        title = decodeHtmlEntities(title);

        // Sätt ihop "datum + titel"
        const displayTitle = (formattedDate ? formattedDate + ' ' : '') + title;

        events.push({ title: displayTitle.trim() });
      }

      if (!eventInterval) {
        showNextEvent();
        // Byt event var 10:e sekund
        eventInterval = setInterval(showNextEvent, 10000);
      }
    } catch (error) {
      console.error(error);
      resetToWelcomeMessage();
    }
  }

  // Visa nästa event
  function showNextEvent() {
    const eventTitleElem = document.getElementById("eventTitle");

    if (events.length > 0) {
      const currentText = events[currentEventIndex].title;

      // Om texten är för lång => marquee
      if (currentText.length > 40) {
        eventTitleElem.innerHTML = `<div class="scroll-text">${currentText}</div>`;
      } else {
        eventTitleElem.textContent = currentText;
      }

      currentEventIndex = (currentEventIndex + 1) % events.length;
    } else {
      resetToWelcomeMessage();
    }
  }

  // Återställ välkomst
  function resetToWelcomeMessage() {
    document.getElementById("eventTitle").textContent = 'VÄLKOMMEN TILL ESKILSTUNA';
  }

  // Init
  fetchRSS();
  // Upprepa var 5:e minut
  setInterval(fetchRSS, 300000);
</script>
</body>
</html>
