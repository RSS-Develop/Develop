<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RSS Läsare (576x64)</title>
  <style>
    /* 
      BODY fyller hela webbläsaren:
      - Svart bakgrund
      - Flex-centering i både X- och Y-led
      - Höjd: 100vh (hela fönstrets höjd)
    */
    body {
      background-color: black;
      color: white;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;

      display: flex; 
      justify-content: center;  /* Centra horisontellt */
      align-items: center;      /* Centra vertikalt */
      height: 100vh;            /* 100% av synliga höjden i webbläsaren */
    }

    /*
      #rssFeed är en ”remsa” på 576×64 px, placerad centralt i skärmen 
      (tack vare body-stylingen).
      Inuti den är texten vänsterställd.
    */
    #rssFeed {
      width: 576px;
      height: 64px;
      box-sizing: border-box;
      display: flex;
      align-items: center;         /* Vertikalt centrerad text i 64 px */
      justify-content: flex-start; /* Vänsterjustera texten */
      padding-left: 10px;         /* Lite luft i vänsterkant */
      overflow: hidden;           /* Dölj ev. rullande text */
    }

    /* Event-titeln */
    #eventTitle {
      font-size: 30px;
      margin: 0;
      line-height: 64px;    /* Samma höjd som remsan */
      white-space: nowrap;
      overflow: hidden;
      position: relative;   /* För marquee-positionering */
      text-align: left;
    }

    /* Marquee (scroll-text) */
    .scroll-text {
      position: absolute;
      line-height: 64px;
      white-space: nowrap;
      /* Börja utanför rutan till höger */
      padding-left: 100%;
      animation: marquee 15s linear infinite;
    }

    @keyframes marquee {
      0%   { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }
  </style>
</head>
<body>
  <div id="rssFeed">
    <div id="eventTitle">VÄLKOMMEN TILL ESKILSTUNA</div>
  </div>

<script>
  // RSS via rss2json
  const rssUrl = 'https://api.rss2json.com/v1/api.json?rss_url=' + 
    encodeURIComponent(
      'https://visiteskilstuna.se/rest-api/rssService/getRssFeed?portletId=12.5b899160171ac5273c72ad9f&pageId=2.369be3c31580a19562d1977e'
    );

  let events = [];
  let currentEventIndex = 0;
  let eventInterval;

  // Svenska månadsnamn (korta & långa, inkl å, ä, ö).
  const swedishMonths = {
    "jan": 1, "januari": 1,
    "feb": 2, "februari": 2,
    "mar": 3, "mars": 3,
    "apr": 4, "april": 4,
    "maj": 5,
    "jun": 6, "juni": 6,
    "jul": 7, "juli": 7,
    "aug": 8, "augusti": 8,
    "sep": 9, "sept": 9, "september": 9,
    "okt": 10, "oktober": 10,
    "nov": 11, "november": 11,
    "dec": 12, "december": 12
  };

  /**
   * Exempel: "5 feb - 8 feb, Folk och Kultur 2025"
   * => formatDateRange() => "5/2 - 8/2"
   * => Rensar sedan bort "5 feb - 8 feb," från titeln.
   */
  function formatDateRange(title) {
    // Fångar "xx mån" eller "xx mån - xx mån"
    const datePattern = /^(\d{1,2})\s*([a-zA-ZåäöÅÄÖ]+)(?:\s*-\s*(\d{1,2})\s*([a-zA-ZåäöÅÄÖ]+))?/i;
    const match = title.match(datePattern);
    if (match) {
      const startDay = parseInt(match[1], 10);
      const startMonthStr = match[2].toLowerCase();
      const startMonthNum = swedishMonths[startMonthStr] || null;
      if (!startMonthNum) return '';

      const endDayStr = match[3];
      const endMonthStr = match[4] ? match[4].toLowerCase() : null;

      if (endDayStr && endMonthStr && swedishMonths[endMonthStr]) {
        const endDay = parseInt(endDayStr, 10);
        const endMonthNum = swedishMonths[endMonthStr];
        return `${startDay}/${startMonthNum} - ${endDay}/${endMonthNum}`;
      } else {
        return `${startDay}/${startMonthNum}`;
      }
    }
    return '';
  }

  /**
   * Tar bort datum + ev. skiljetecken. T.ex.
   * "5 feb - 8 feb, Folk och Kultur 2025" -> "Folk och Kultur 2025"
   * "... -> " 
   */
  function removeDateFromTitle(title) {
    /* 
       Här matchar vi:
         1) (\d{1,2}\s*[a-zA-ZåäöÅÄÖ]+(?:\s*-\s*\d{1,2}\s*[a-zA-ZåäöÅÄÖ]+)?) 
            => t.ex. "5 feb - 8 feb" eller "5 feb"
         2) [\s,:\-–]+ => mellanslag eller kommatering efter datumet
    */
    return title.replace(
      /^(\d{1,2}\s*[a-zA-ZåäöÅÄÖ]+(?:\s*-\s*\d{1,2}\s*[a-zA-ZåäöÅÄÖ]+)?)[\s,:\-–]+/i,
      ''
    ).trim();
  }

  // Avkoda HTML (ex &amp; -> &)
  function decodeHtmlEntities(text) {
    const textarea = document.createElement('textarea');
    textarea.innerHTML = text;
    return textarea.value;
  }

  // Hämta RSS
  async function fetchRSS() {
    try {
      const response = await fetch(rssUrl);
      if (!response.ok) throw new Error("Kunde inte hämta RSS-flödet.");

      const data = await response.json();
      const items = data.items;

      events = [];

      for (let i = 0; i < items.length; i++) {
        let title = items[i].title || '';
        title = title.trim();

        // Hämta formaterat datumintervall
        const formattedDate = formatDateRange(title);

        // Ta bort datum + ev. kommatecken/bindestreck direkt efter
        title = removeDateFromTitle(title);

        // Avkoda eventuella HTML-entities
        title = decodeHtmlEntities(title);

        // Slutlig text -> "datum eventTitel" 
        // (om formattedDate finns)
        const displayTitle = (formattedDate ? formattedDate + ' ' : '') + title;

        events.push({ title: displayTitle.trim() });
      }

      // Om ingen interval redan kör, starta
      if (!eventInterval) {
        showNextEvent();
        // Byt event var 10:e sekund
        eventInterval = setInterval(showNextEvent, 10000);
      }
    } catch (error) {
      console.error(error);
      resetToWelcomeMessage();
    }
  }

  // Visar nästa event
  function showNextEvent() {
    const eventTitleElem = document.getElementById("eventTitle");

    if (events.length > 0) {
      const currentText = events[currentEventIndex].title;
      
      // Om texten är längre än 40 tecken -> marquee
      if (currentText.length > 40) {
        eventTitleElem.innerHTML = `<div class="scroll-text">${currentText}</div>`;
      } else {
        eventTitleElem.textContent = currentText;
      }

      currentEventIndex = (currentEventIndex + 1) % events.length;
    } else {
      resetToWelcomeMessage();
    }
  }

  // Återställ till välkomsttext
  function resetToWelcomeMessage() {
    document.getElementById("eventTitle").textContent = 'VÄLKOMMEN TILL ESKILSTUNA';
  }

  // Hämta RSS direkt
  fetchRSS();
  // Sedan var 5:e minut
  setInterval(fetchRSS, 300000);
</script>
</body>
</html>
