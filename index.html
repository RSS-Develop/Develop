<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=576, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eskilstuna Info</title>
    <style>
        body {
            background-color: black;
            color: white;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            width: 576px;
            height: 64px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #eventText {
            white-space: nowrap;
            max-width: 100%;
            margin: 0;
            padding: 0 10px;
            line-height: 1.2;
            text-align: center;
            transition: font-size 0.3s ease;
        }
    </style>
</head>
<body>
    <div id="eventText">Välkommen till Eskilstuna</div>

<script>
const RSS_URL = 'https://api.rss2json.com/v1/api.json?rss_url=' + encodeURIComponent('https://visiteskilstuna.se/rest-api/rssService/getRssFeed?portletId=12.5b899160171ac5273c72ad9f&pageId=2.369be3c31580a19562d1977e');
const BASE_FONT_SIZE = 36; // Storlek för 31 tecken
const CONTAINER_WIDTH = 576;
let events = [];
let currentEventIndex = 0;
const monthMap = {
    "jan": "1", "feb": "2", "mar": "3", "apr": "4",
    "maj": "5", "jun": "6", "jul": "7", "aug": "8",
    "sep": "9", "okt": "10", "nov": "11", "dec": "12"
};

// Dynamisk textstorleksberäkning
function calculateFontSize(text) {
    const baseLength = 31; // Baslängd för BASE_FONT_SIZE
    const minFontSize = 24; // Minsta tillåtna textstorlek
    
    // Beräkna förhållande mellan aktuell textlängd och baslängd
    const lengthRatio = Math.min(text.length / baseLength, 2); // Begränsa max till dubbla längden
    const calculatedSize = BASE_FONT_SIZE / lengthRatio;
    
    return Math.max(calculatedSize, minFontSize);
}

function formatDate(title) {
    const dateMatch = title.match(/(\d{1,2})\s*([a-zåäö]+)\s*([-–]\s*(\d{1,2})\s*([a-zåäö]+))?/i);
    if (!dateMatch) return '';
    
    const startDay = dateMatch[1];
    const startMonth = monthMap[dateMatch[2].toLowerCase()];
    
    if (dateMatch[4] && dateMatch[5]) {
        const endDay = dateMatch[4];
        const endMonth = monthMap[dateMatch[5].toLowerCase()];
        return `${startDay}/${startMonth}–${endDay}/${endMonth}`;
    }
    return `${startDay}/${startMonth}`;
}

async function fetchData() {
    try {
        const response = await fetch(RSS_URL);
        if (!response.ok) throw new Error('Kunde inte hämta data');
        
        const data = await response.json();
        events = [];
        
        data.items.forEach(item => {
            let title = item.title?.trim() || '';
            const date = formatDate(title);
            title = title.replace(/^(\d{1,2}\s*[a-zåäö]+(\s*[-–]\s*\d{1,2}\s*[a-zåäö]+)?)(\s*[,\-–:]?\s*)?/i, '').trim();
            
            if (date) {
                const fullText = `${date} ${title}`;
                events.push(fullText);
            }
        });
        
        if (events.length > 0) {
            currentEventIndex = 0;
            updateDisplay();
        }
    } catch (error) {
        console.error('Fel:', error);
        showWelcomeMessage();
    }
}

function updateDisplay() {
    const displayElement = document.getElementById('eventText');
    if (events.length > 0) {
        const currentText = events[currentEventIndex];
        displayElement.textContent = currentText;
        displayElement.style.fontSize = `${calculateFontSize(currentText)}px`;
        currentEventIndex = (currentEventIndex + 1) % events.length;
    } else {
        showWelcomeMessage();
    }
}

function showWelcomeMessage() {
    const displayElement = document.getElementById('eventText');
    displayElement.textContent = 'Välkommen till Eskilstuna';
    displayElement.style.fontSize = `${BASE_FONT_SIZE}px`;
}

// Initial uppdatering och regelbunden uppdatering
fetchData();
setInterval(fetchData, 300000);
setInterval(updateDisplay, 10000);
</script>
</body>
</html>
